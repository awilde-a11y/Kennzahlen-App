<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Due-Diligence KPI App – v7.1 (Hybrid)</title>

  <!-- PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* ====== BASIC ====== */
    :root{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      --bg:#f6f7fb; --card:#fff; --text:#111; --muted:#666; --border:#e9ecf5;
      --green:#1c7c2f; --yellow:#8a5a00; --red:#b00020;
      --rent:#2f6fff; --eff:#f2b400; --liq:#2bb673; --ecom:#8a5cf6;
    }
    body{margin:0;background:var(--bg);color:var(--text)}
    .wrap{max-width:1200px;margin:auto;padding:18px}
    .card{background:var(--card);border-radius:18px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:16px}
    h1{margin:0;font-size:20px}
    .sub{margin-top:6px;font-size:13px;color:#555}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .btn{padding:10px 12px;border-radius:12px;border:1px solid #111;background:#111;color:#fff;cursor:pointer}
    .btn.secondary{background:#fff;color:#111;border-color:#d9dbe6}
    .pill{padding:6px 10px;border-radius:999px;font-size:12px;background:#f1f2f7;border:1px solid #e4e6f1}
    .hr{height:1px;background:var(--border);margin:14px 0}

    /* ====== TABS ====== */
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:14px 0}
    .tabbtn{border-radius:999px;border:1px solid #d9dbe6;background:#fff;padding:9px 12px;cursor:pointer}
    .tabbtn.active{background:#111;color:#fff}
    .tab{display:none}.tab.active{display:block}

    /* ====== BADGES ====== */
    .badge{padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #e4e6f1;font-weight:700}
    .green{background:#f0fff3;color:var(--green)}
    .yellow{background:#fff7e6;color:var(--yellow)}
    .red{background:#fff0f0;color:var(--red)}

    /* ====== TREND ====== */
    .chartWrap{border:1px solid var(--border);border-radius:16px;padding:12px;margin-top:12px}
    canvas{width:100%;height:300px}
    .warn{margin-top:10px;font-size:13px}
    .warn span{display:block;margin-top:4px}

    /* ====== TABLE ====== */
    table{width:100%;border-collapse:collapse;font-size:13px;margin-top:10px}
    th,td{padding:8px;border-bottom:1px solid var(--border)}
    th{text-transform:uppercase;font-size:12px;color:#444}
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <div class="row">
      <div>
        <h1>Due-Diligence KPI App</h1>
        <div class="sub">Hybrid-Benchmark · Trend · Vergleich · PDF · Backup</div>
      </div>
      <div class="row">
        <span class="pill">v7.1</span>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tabbtn active" data-tab="trend">Trend</button>
      <button class="tabbtn" data-tab="compare">Vergleich</button>
      <button class="tabbtn" data-tab="backup">Backup</button>
    </div>

    <!-- ================= TREND ================= -->
    <div class="tab active" id="trend">
      <h2>Trend (Hybrid)</h2>

      <div class="row">
        <select id="trendType">
          <option value="Monat">Monat</option>
          <option value="Quartal">Quartal</option>
          <option value="Jahr">Jahr</option>
        </select>
        <button class="btn" id="drawTrend">Trend anzeigen</button>
      </div>

      <div class="chartWrap">
        <canvas id="trendCanvas"></canvas>
        <div class="warn" id="warnings"></div>
      </div>
    </div>

    <!-- ================= VERGLEICH ================= -->
    <div class="tab" id="compare">
      <h2>Vergleich (Top-Treiber)</h2>
      <div class="row">
        <select id="cmpA"></select>
        <select id="cmpB"></select>
        <button class="btn" id="runCompare">Vergleich</button>
      </div>
      <div id="compareOut"></div>
    </div>

    <!-- ================= BACKUP ================= -->
    <div class="tab" id="backup">
      <h2>Backup / Import</h2>
      <div class="row">
        <button class="btn secondary" id="exportBackup">Backup exportieren</button>
        <input type="file" id="importFile" style="display:none"/>
        <button class="btn secondary" id="importBackup">Backup importieren</button>
      </div>
      <div class="sub">Damit kannst du die App auf ein neues Gerät mitnehmen.</div>
    </div>

  </div>
</div>

<script>
/* =========================================================
   v7.1 – KERNLOGIK (kompakt, stabil)
   ========================================================= */

const STORE_KEY = "ddkpi_periods_v7";
const $ = id => document.getElementById(id);

/* ---------- Demo-Datenstruktur (Beispiel) ----------
   In deiner echten App kommen diese Daten
   aus dem Reiter „Zeiträume speichern“.
---------------------------------------------------- */
if(!localStorage.getItem(STORE_KEY)){
  const demo = [
    {type:"Monat",label:"2026-01",scores:{total:72,rent:70,eff:68,liq:75,ecom:74}},
    {type:"Monat",label:"2026-02",scores:{total:69,rent:68,eff:65,liq:73,ecom:70}},
    {type:"Monat",label:"2026-03",scores:{total:63,rent:64,eff:58,liq:70,ecom:60}},
    {type:"Monat",label:"2026-04",scores:{total:61,rent:62,eff:55,liq:68,ecom:58}},
  ];
  localStorage.setItem(STORE_KEY, JSON.stringify(demo));
}

/* ---------- Trend ---------- */
function getTrend(type){
  return JSON.parse(localStorage.getItem(STORE_KEY)||"[]")
    .filter(x=>x.type===type)
    .sort((a,b)=>a.label.localeCompare(b.label));
}

function drawTrend(){
  const type = $("trendType").value;
  const data = getTrend(type);
  const c = $("trendCanvas");
  const ctx = c.getContext("2d");

  c.width = c.clientWidth;
  c.height = 300;
  ctx.clearRect(0,0,c.width,c.height);

  if(!data.length){
    ctx.fillText("Keine Daten",20,40);
    return;
  }

  const lines = [
    {k:"total",color:"#111"},
    {k:"rent",color:getComputedStyle(document.documentElement).getPropertyValue("--rent")},
    {k:"eff",color:getComputedStyle(document.documentElement).getPropertyValue("--eff")},
    {k:"liq",color:getComputedStyle(document.documentElement).getPropertyValue("--liq")},
    {k:"ecom",color:getComputedStyle(document.documentElement).getPropertyValue("--ecom")},
  ];

  const pad = 40;
  const W = c.width-pad*2;
  const H = c.height-pad*2;

  function x(i){return pad + W*(i/(data.length-1||1))}
  function y(v){return pad + H*(1-v/100)}

  // Grid
  ctx.strokeStyle="#e9ecf5";
  for(let i=0;i<=5;i++){
    const yy = pad + H*(i/5);
    ctx.beginPath();ctx.moveTo(pad,yy);ctx.lineTo(pad+W,yy);ctx.stroke();
  }

  // Lines
  lines.forEach(l=>{
    ctx.strokeStyle=l.color;
    ctx.beginPath();
    data.forEach((d,i)=>{
      const px=x(i), py=y(d.scores[l.k]);
      if(i===0)ctx.moveTo(px,py); else ctx.lineTo(px,py);
    });
    ctx.stroke();
  });

  // Labels
  ctx.fillStyle="#666"; ctx.font="12px system-ui";
  data.forEach((d,i)=>ctx.fillText(d.label,x(i)-15,pad+H+20));

  renderWarnings(data);
}

/* ---------- Warnungen ---------- */
function renderWarnings(data){
  const w = $("warnings");
  w.innerHTML="";
  if(data.length<3) return;

  const last3 = data.slice(-3).map(x=>x.scores.total);
  if(last3[2]<last3[1] && last3[1]<last3[0]){
    w.innerHTML += "<span>⚠️ 3 Zeiträume in Folge schlechter (Gesamt)</span>";
  }
  const drop = data[data.length-2].scores.total - data[data.length-1].scores.total;
  if(drop>10){
    w.innerHTML += "<span>⚠️ Starker Einbruch (>10 Punkte)</span>";
  }
}

/* ---------- Vergleich ---------- */
function renderCompareSelects(){
  const all = JSON.parse(localStorage.getItem(STORE_KEY)||"[]");
  $("cmpA").innerHTML = all.map((x,i)=>`<option value="${i}">${x.type} ${x.label}</option>`).join("");
  $("cmpB").innerHTML = $("cmpA").innerHTML;
  if(all.length>1){$("cmpA").value=all.length-2; $("cmpB").value=all.length-1;}
}
function runCompare(){
  const all = JSON.parse(localStorage.getItem(STORE_KEY)||"[]");
  const A = all[$("cmpA").value];
  const B = all[$("cmpB").value];
  if(!A||!B) return;
  const deltas = Object.keys(A.scores).map(k=>({k, d:B.scores[k]-A.scores[k]}))
    .sort((a,b)=>b.d-a.d);
  $("compareOut").innerHTML = `
    <h3>Top-Treiber</h3>
    <b>Verbesserungen</b>
    <ul>${deltas.slice(0,3).map(x=>`<li>${x.k}: +${x.d.toFixed(1)}</li>`).join("")}</ul>
    <b>Verschlechterungen</b>
    <ul>${deltas.slice(-3).map(x=>`<li>${x.k}: ${x.d.toFixed(1)}</li>`).join("")}</ul>
  `;
}

/* ---------- Backup ---------- */
function exportBackup(){
  const blob = new Blob([localStorage.getItem(STORE_KEY)||"[]"],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="ddkpi_backup.json";
  a.click();
}
function importBackup(file){
  const r=new FileReader();
  r.onload=()=>{localStorage.setItem(STORE_KEY,r.result); alert("Import OK");};
  r.readAsText(file);
}

/* ---------- Events ---------- */
document.querySelectorAll(".tabbtn").forEach(b=>b.onclick=()=>{
  document.querySelectorAll(".tabbtn").forEach(x=>x.classList.remove("active"));
  document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
  b.classList.add("active");
  $(b.dataset.tab).classList.add("active");
});
$("drawTrend").onclick=drawTrend;
$("runCompare").onclick=runCompare;
$("exportBackup").onclick=exportBackup;
$("importBackup").onclick=()=>$("importFile").click();
$("importFile").onchange=e=>importBackup(e.target.files[0]);

renderCompareSelects();
drawTrend();
</script>
</body>
</html>
