<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Due-Diligence KPI App</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      --bg:#f6f7fb;
      --card:#fff;
      --text:#111;
      --muted:#666;
      --border:#e9ecf5;
      --shadow:0 6px 18px rgba(0,0,0,.06);

      --green-bg:#f0fff3; --green-bd:#d9f5df; --green-tx:#1c7c2f;
      --yellow-bg:#fff7e6; --yellow-bd:#ffe2a8; --yellow-tx:#8a5a00;
      --red-bg:#fff0f0; --red-bd:#ffd6d6; --red-tx:#b00020;

      --rent:#2f6fff;
      --eff:#f2b400;
      --liq:#2bb673;
      --ecom:#8a5cf6;
    }

    body{ margin:0; background:var(--bg); color:var(--text); }
    .wrap{ max-width:1150px; margin:0 auto; padding:18px; }
    .card{ background:var(--card); border-radius:18px; box-shadow:var(--shadow); padding:16px; }
    h1{ margin:0; font-size:20px; }
    .sub{ margin:6px 0 0; color:#555; font-size:13px; }

    h2{ margin:18px 0 8px; font-size:15px; }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:900px){ .grid{ grid-template-columns:1fr; } }

    label{ display:block; font-size:12px; color:var(--muted); margin:10px 0 6px; }
    input{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid #d9dbe6;
      font:inherit; box-sizing:border-box; background:#fff; color:#111;
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .btn{
      padding:10px 12px; border-radius:12px; border:1px solid #111;
      background:#111; color:#fff; font:inherit; cursor:pointer;
    }
    .btn.secondary{ background:#fff; color:#111; border:1px solid #d9dbe6; }
    .pill{ padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid #e4e6f1; background:#f1f2f7; white-space:nowrap; }
    .hr{ height:1px; background:var(--border); border:0; margin:14px 0; }
    .note{ font-size:12px; color:var(--muted); }

    /* Badges / Ampel */
    .badge{
      padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid #e4e6f1;
      background:#f1f2f7; white-space:nowrap; font-weight:700; display:inline-flex; align-items:center; gap:6px;
    }
    .green{ background:var(--green-bg); border-color:var(--green-bd); color:var(--green-tx); }
    .yellow{ background:var(--yellow-bg); border-color:var(--yellow-bd); color:var(--yellow-tx); }
    .red{ background:var(--red-bg); border-color:var(--red-bd); color:var(--red-tx); }

    /* Result layout */
    .scoreCard{
      border:1px solid var(--border); border-radius:16px; padding:12px; background:#fafbff;
      display:flex; justify-content:space-between; gap:12px; align-items:flex-start;
    }
    .big{ font-size:22px; font-weight:900; }
    .muted{ color:var(--muted); font-size:12px; }
    .small{ font-size:12px; color:#555; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .sectionsGrid{
      display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px;
    }
    @media (max-width:1000px){ .sectionsGrid{ grid-template-columns:1fr; } }

    .sectionBox{
      border:1px solid var(--border); border-radius:16px; background:#fff; overflow:hidden;
    }
    .sectionHead{
      padding:12px;
      display:flex; justify-content:space-between; align-items:flex-start; gap:12px;
      border-bottom:1px solid var(--border);
    }
    .sectionTitleRow{ display:flex; align-items:center; gap:10px; }
    .dot{
      width:10px; height:10px; border-radius:999px; background:#999; flex:0 0 auto;
      box-shadow:0 0 0 6px rgba(0,0,0,0.03);
    }
    .dot.rent{ background:var(--rent); }
    .dot.eff{ background:var(--eff); }
    .dot.liq{ background:var(--liq); }
    .dot.ecom{ background:var(--ecom); }

    .sectionName{ font-weight:900; }
    .sectionWeight{ color:var(--muted); font-size:12px; margin-top:2px; }

    .kpiList{ padding:10px 12px 12px; display:flex; flex-direction:column; gap:10px; }
    .kpiRow{
      display:grid;
      grid-template-columns: 1fr auto auto;
      gap:10px;
      align-items:center;
      padding:10px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
    }
    .kpiName{ font-weight:700; }
    .kpiExplain{ font-size:12px; color:var(--muted); margin-top:2px; }
    .kpiValue{ font-weight:900; }
    .kpiMeta{ font-size:12px; color:#555; }

    /* Inputs grouped */
    .inputSection{
      border:1px solid var(--border);
      border-radius:16px;
      background:#fff;
      overflow:hidden;
      margin-top:12px;
    }
    .inputHead{
      padding:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
      border-bottom:1px solid var(--border);
      background:#fafbff;
    }
    .inputTitle{
      display:flex; align-items:center; gap:10px;
      font-weight:900;
    }
    .help{
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
      line-height:1.35;
    }
    .help b{ color:#333; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <div class="row">
      <div>
        <h1>Due-Diligence KPI App</h1>
        <div class="sub">Werte eingeben â†’ Zuordnung pro Bereich â†’ KPIs + Ampel + PDF (je Bereich 1 Seite)</div>
      </div>
      <div class="row">
        <span class="pill">v3</span>
        <button class="btn secondary" id="fillDemo">Demo-Werte</button>
        <button class="btn secondary" id="reset">Reset</button>
      </div>
    </div>

    <!-- INPUTS grouped with "needed for" -->
    <div class="inputSection">
      <div class="inputHead">
        <div class="inputTitle"><span class="dot rent"></span> ðŸŸ¦ RentabilitÃ¤t â€“ Eingaben</div>
        <span class="pill">fÃ¼r Rohertrag / EBITDA / Netto / ROI</span>
      </div>
      <div class="grid" style="padding:12px;">
        <div>
          <label>Umsatz (â‚¬)</label>
          <input id="umsatz" placeholder="z. B. 1.250.000" inputmode="decimal">
          <div class="help"><b>BenÃ¶tigt fÃ¼r:</b> RentabilitÃ¤t â†’ Rohertrag, EBITDA-Marge, Netto-Marge | Effizienz â†’ Umsatz/MA, Umsatz/mÂ² | LiquiditÃ¤t â†’ Cashflow-Quote, Working-Capital-Benchmark | E-Commerce â†’ Marketingquote, AOV, Retourenquote</div>

          <label>Wareneinsatz (â‚¬)</label>
          <input id="wareneinsatz" placeholder="z. B. 720.000" inputmode="decimal">
          <div class="help"><b>BenÃ¶tigt fÃ¼r:</b> RentabilitÃ¤t â†’ Rohertrag | Effizienz â†’ Lagerumschlag</div>

          <label>EBITDA (â‚¬)</label>
          <input id="ebitda" placeholder="z. B. 140.000" inputmode="decimal">
          <div class="help"><b>BenÃ¶tigt fÃ¼r:</b> RentabilitÃ¤t â†’ EBITDA-Marge</div>

          <label>JahresÃ¼berschuss (â‚¬)</label>
          <input id="jahresueberschuss" placeholder="z. B. 70.000" inputmode="decimal">
          <div class="help"><b>BenÃ¶tigt fÃ¼r:</b> RentabilitÃ¤t â†’ Netto-Marge, ROI</div>
        </div>

        <div>
          <label>Eigenkapital (â‚¬)</label>
          <input id="eigenkapital" placeholder="z. B. 280.000" inputmode="decimal">
          <div class="help"><b>BenÃ¶tigt fÃ¼r:</b> RentabilitÃ¤t â†’ ROI | LiquiditÃ¤t â†’ Eigenkapitalquote</div>

          <label>Gesamtkapital (â‚¬)</label>
          <input id="gesamtkapital" placeholder="z. B. 900.000" inputmode="decimal">
          <div class="help"><b>BenÃ¶tigt fÃ¼r:</b> LiquiditÃ¤t â†’ Eigenkapitalquote</div>
        </div>
      </div>
    </div>

    <div class="inputSection">
      <div class="inputHead">
        <div class="inputTitle"><span class="dot eff"></span> ðŸŸ¨ Effizienz â€“ Eingaben</div>
        <span class="pill">fÃ¼r Lagerumschlag / Umsatz pro MA / Umsatz pro mÂ²</span>
      </div>
      <div class="grid" style="padding:12px;">
        <div>
          <label>Ã˜ Lagerbestand (â‚¬)</label>
          <input id="lagerbestand" placeholder="z. B. 180.000" inputmode="decimal">
          <div class="help"><b>BenÃ¶tigt fÃ¼r:</b> Effizienz â†’ Lagerumschlag</div>

          <label>Mitarbeiter (FTE)</label>
          <input id="mitarbeiter" placeholder="z. B. 8" inputmode="decimal">
          <div class="help"><b>BenÃ¶tigt fÃ¼r:</b> Effizienz â†’ Umsatz/MA</div>
        </div>
        <div>
          <label>VerkaufsflÃ¤che (mÂ²)</label>
          <input id="verkaufsflaeche" placeholder="z. B. 250" inputmode="decimal">
          <div class="help"><b>BenÃ¶tigt fÃ¼r:</b> Effizienz â†’ Umsatz/mÂ²</div>
        </div>
      </div>
    </div>

    <div class="inputSection">
      <div class="inputHead">
        <div class="inputTitle"><span class="dot liq"></span> ðŸŸ© LiquiditÃ¤t â€“ Eingaben</div>
        <span class="pill">fÃ¼r EK-Quote / Working Capital / Cashflow-Quote</span>
      </div>
      <div class="grid" style="padding:12px;">
        <div>
          <label>UmlaufvermÃ¶gen (â‚¬)</label>
          <input id="umlaufvermoegen" placeholder="z. B. 320.000" inputmode="decimal">
          <div class="help"><b>BenÃ¶tigt fÃ¼r:</b> LiquiditÃ¤t â†’ Working Capital</div>

          <label>Kurzfr. Verbindlichkeiten (â‚¬)</label>
          <input id="kurzfristigeVerbindlichkeiten" placeholder="z. B. 210.000" inputmode="decimal">
          <div class="help"><b>BenÃ¶tigt fÃ¼r:</b> LiquiditÃ¤t â†’ Working Capital</div>
        </div>
        <div>
          <label>Operativer Cashflow (â‚¬)</label>
          <input id="operativerCashflow" placeholder="z. B. 95.000" inputmode="decimal">
          <div class="help"><b>BenÃ¶tigt fÃ¼r:</b> LiquiditÃ¤t â†’ Cashflow-Quote</div>
        </div>
      </div>
    </div>

    <div class="inputSection">
      <div class="inputHead">
        <div class="inputTitle"><span class="dot ecom"></span> ðŸŸª E-Commerce â€“ Eingaben</div>
        <span class="pill">fÃ¼r Marketingquote / Conversion / AOV / Retourenquote</span>
      </div>
      <div class="grid" style="padding:12px;">
        <div>
          <label>Marketingkosten (â‚¬)</label>
          <input id="marketingkosten" placeholder="z. B. 85.000" inputmode="decimal">
          <div class="help"><b>BenÃ¶tigt fÃ¼r:</b> E-Commerce â†’ Marketingquote</div>

          <label>Bestellungen (Anzahl)</label>
          <input id="bestellungen" placeholder="z. B. 12.500" inputmode="decimal">
          <div class="help"><b>BenÃ¶tigt fÃ¼r:</b> E-Commerce â†’ Conversion Rate, AOV</div>
        </div>

        <div>
          <label>Shopbesucher (Anzahl)</label>
          <input id="shopbesucher" placeholder="z. B. 520.000" inputmode="decimal">
          <div class="help"><b>BenÃ¶tigt fÃ¼r:</b> E-Commerce â†’ Conversion Rate</div>

          <label>Retouren (â‚¬)</label>
          <input id="retouren" placeholder="z. B. 55.000" inputmode="decimal">
          <div class="help"><b>BenÃ¶tigt fÃ¼r:</b> E-Commerce â†’ Retourenquote</div>
        </div>
      </div>
    </div>

    <div class="hr"></div>

    <div class="row">
      <button class="btn" id="calc">Kennzahlen berechnen</button>
      <div class="row">
        <button class="btn secondary" id="pdf">PDF exportieren</button>
      </div>
    </div>

    <div id="results" style="display:none;">
      <div class="hr"></div>

      <div class="scoreCard">
        <div>
          <div class="muted">Gesamtscore (4 Bereiche je 25%)</div>
          <div class="big" id="totalScoreText">â€”</div>
          <div class="small" id="totalInterpretation">â€”</div>
          <div class="muted" id="totalExplain">â€”</div>
        </div>
        <span class="badge" id="totalBadge">â€”</span>
      </div>

      <div class="sectionsGrid" id="sections"></div>

      <div class="note" style="margin-top:10px;">
        Benchmarks & KPI-Gewichte sind im Code zentral in <span class="mono">CONFIG</span> definiert.
      </div>
    </div>

  </div>
</div>

<script>
  const $ = (id) => document.getElementById(id);

  function num(id){
    const raw = ($(id).value || "").toString().trim();
    if(!raw) return 0;
    const cleaned = raw.replace(/\s/g,"").replace(/\./g,"").replace(",",".");
    const n = Number(cleaned);
    return Number.isFinite(n) ? n : 0;
  }
  function safeDiv(a,b){ return b ? (a/b) : 0; }
  function pct(x){ return x * 100; }

  function fmtEUR(n){ return n.toLocaleString("de-DE", {maximumFractionDigits:0}); }
  function fmt(n, digits=2){ return n.toLocaleString("de-DE", {maximumFractionDigits:digits, minimumFractionDigits:digits}); }
  function formatValue(val, type){
    if(type === "pct") return `${fmt(val)} %`;
    if(type === "eur0") return `${fmtEUR(val)} â‚¬`;
    return `${fmt(val, 2)}`;
  }

  function badgeFor(value, bm){
    if (bm.type === "higherBetter"){
      if (value >= bm.green) return {cls:"green", text:"ðŸŸ¢ GrÃ¼n"};
      if (value >= bm.yellow) return {cls:"yellow", text:"ðŸŸ¡ Gelb"};
      return {cls:"red", text:"ðŸ”´ Rot"};
    } else {
      if (value <= bm.green) return {cls:"green", text:"ðŸŸ¢ GrÃ¼n"};
      if (value <= bm.yellow) return {cls:"yellow", text:"ðŸŸ¡ Gelb"};
      return {cls:"red", text:"ðŸ”´ Rot"};
    }
  }

  function scoreFromBenchmark(value, bm){
    if (!Number.isFinite(value)) return 0;

    if (bm.type === "higherBetter"){
      if (value <= bm.red) return 0;
      if (value >= bm.green) return 100;
      return ((value - bm.red) / (bm.green - bm.red)) * 100;
    } else {
      if (value >= bm.red) return 0;
      if (value <= bm.green) return 100;
      return ((bm.red - value) / (bm.red - bm.green)) * 100;
    }
  }

  function interpretTotal(score){
    if (score >= 75) return {label:"sehr gut", hint:"Sehr gute Gesamtperformance im Benchmark-Vergleich."};
    if (score >= 60) return {label:"solide", hint:"Solide â€“ es gibt Optimierungspotenzial in einzelnen Bereichen."};
    return {label:"kritisch", hint:"Kritisch â€“ mehrere Benchmarks werden deutlich verfehlt."};
  }

  function totalBadgeFromScore(s){
    if (s >= 75) return {cls:"green", text:"ðŸŸ¢ Sehr gut"};
    if (s >= 60) return {cls:"yellow", text:"ðŸŸ¡ Solide"};
    return {cls:"red", text:"ðŸ”´ Kritisch"};
  }

  const CONFIG = {
    sections: [
      {
        id:"rent", dotClass:"rent", titleEmoji:"ðŸŸ¦", name:"RentabilitÃ¤t", weightTotal:0.25,
        kpis:[
          { id:"rohertrag", name:"Rohertrag", type:"pct", explain:"(Umsatz âˆ’ Wareneinsatz) / Umsatz", weight:0.30, benchmark:{type:"higherBetter", red:15, yellow:20, green:30}},
          { id:"ebitdaMarge", name:"EBITDA-Marge", type:"pct", explain:"EBITDA / Umsatz", weight:0.30, benchmark:{type:"higherBetter", red:3, yellow:5, green:12}},
          { id:"nettoMarge", name:"Netto-Marge", type:"pct", explain:"JahresÃ¼berschuss / Umsatz", weight:0.20, benchmark:{type:"higherBetter", red:1, yellow:2, green:6}},
          { id:"roi", name:"ROI", type:"pct", explain:"JahresÃ¼berschuss / Eigenkapital", weight:0.20, benchmark:{type:"higherBetter", red:5, yellow:10, green:18}}
        ]
      },
      {
        id:"eff", dotClass:"eff", titleEmoji:"ðŸŸ¨", name:"Effizienz", weightTotal:0.25,
        kpis:[
          { id:"lagerUmschlag", name:"Lagerumschlag", type:"num", explain:"Wareneinsatz / Ã˜ Lagerbestand", weight:0.35, benchmark:{type:"higherBetter", red:1.5, yellow:2.0, green:4.0}},
          { id:"umsatzProMA", name:"Umsatz / MA", type:"eur0", explain:"Umsatz / FTE", weight:0.35, benchmark:{type:"higherBetter", red:120000, yellow:150000, green:230000}},
          { id:"umsatzProQM", name:"Umsatz / mÂ²", type:"eur0", explain:"Umsatz / VerkaufsflÃ¤che", weight:0.30, benchmark:{type:"higherBetter", red:2500, yellow:3000, green:5500}}
        ]
      },
      {
        id:"liq", dotClass:"liq", titleEmoji:"ðŸŸ©", name:"LiquiditÃ¤t", weightTotal:0.25,
        kpis:[
          { id:"ekQuote", name:"Eigenkapitalquote", type:"pct", explain:"Eigenkapital / Gesamtkapital", weight:0.35, benchmark:{type:"higherBetter", red:8, yellow:12, green:25}},
          { id:"workingCapital", name:"Working Capital", type:"eur0", explain:"UmlaufvermÃ¶gen âˆ’ kurzfr. Verbindlichkeiten", weight:0.35, benchmark:{type:"higherBetter", red:0, yellow:1, green:1}},
          { id:"cashflowQuote", name:"Cashflow-Quote", type:"pct", explain:"Operativer CF / Umsatz", weight:0.30, benchmark:{type:"higherBetter", red:1, yellow:2, green:6}}
        ]
      },
      {
        id:"ecom", dotClass:"ecom", titleEmoji:"ðŸŸª", name:"E-Commerce", weightTotal:0.25,
        kpis:[
          { id:"marketingQuote", name:"Marketingquote", type:"pct", explain:"Marketingkosten / Umsatz", weight:0.25, benchmark:{type:"lowerBetter", green:10, yellow:15, red:20}},
          { id:"conversion", name:"Conversion Rate", type:"pct", explain:"Bestellungen / Shopbesucher", weight:0.35, benchmark:{type:"higherBetter", red:0.6, yellow:1.0, green:2.2}},
          { id:"aov", name:"AOV (Ã˜ Warenkorb)", type:"eur0", explain:"Umsatz / Bestellungen", weight:0.20, benchmark:{type:"higherBetter", red:60, yellow:80, green:130}},
          { id:"retourenQuote", name:"Retourenquote", type:"pct", explain:"Retouren / Umsatz", weight:0.20, benchmark:{type:"lowerBetter", green:5, yellow:9, red:15}}
        ]
      }
    ]
  };

  function computeKPIs(){
    const u  = num("umsatz");
    const w  = num("wareneinsatz");
    const e  = num("ebitda");
    const j  = num("jahresueberschuss");
    const ek = num("eigenkapital");
    const gk = num("gesamtkapital");
    const lb = num("lagerbestand");
    const ma = num("mitarbeiter");
    const vf = num("verkaufsflaeche");
    const uv = num("umlaufvermoegen");
    const kv = num("kurzfristigeVerbindlichkeiten");
    const cf = num("operativerCashflow");
    const mk = num("marketingkosten");
    const b  = num("bestellungen");
    const s  = num("shopbesucher");
    const r  = num("retouren");

    if(u <= 0) throw new Error("Bitte mindestens Umsatz > 0 eingeben.");

    const values = {
      rohertrag: pct(safeDiv((u - w), u)),
      ebitdaMarge: pct(safeDiv(e, u)),
      nettoMarge: pct(safeDiv(j, u)),
      roi: pct(safeDiv(j, ek)),

      lagerUmschlag: safeDiv(w, lb),
      umsatzProMA: safeDiv(u, ma),
      umsatzProQM: safeDiv(u, vf),

      ekQuote: pct(safeDiv(ek, gk)),
      workingCapital: (uv - kv),
      cashflowQuote: pct(safeDiv(cf, u)),

      marketingQuote: pct(safeDiv(mk, u)),
      conversion: pct(safeDiv(b, s)),
      aov: safeDiv(u, b),
      retourenQuote: pct(safeDiv(r, u))
    };

    return { input:{u,w,e,j,ek,gk,lb,ma,vf,uv,kv,cf,mk,b,s,r}, values };
  }

  function buildKpiRow(kpi, value, badge, score){
    return `
      <div class="kpiRow">
        <div>
          <div class="kpiName">- ${kpi.name}</div>
          <div class="kpiExplain">${kpi.explain}</div>
          <div class="kpiMeta">Benchmark-Gewicht: <span class="mono">${kpi.weight}</span> â€¢ KPI-Score: <span class="mono">${score.toFixed(1)}</span>/100</div>
        </div>
        <div class="kpiValue">${formatValue(value, kpi.type)}</div>
        <span class="badge ${badge.cls}">${badge.text}</span>
      </div>
    `;
  }

  function buildSectionBox(section, secScore, secBadge, kpiRowsHtml){
    const box = document.createElement("div");
    box.className = "sectionBox";
    box.innerHTML = `
      <div class="sectionHead">
        <div>
          <div class="sectionTitleRow">
            <span class="dot ${section.dotClass}"></span>
            <div>
              <div class="sectionName">${section.titleEmoji} ${section.name} <span class="small">(25%)</span></div>
              <div class="sectionWeight">Bereichsscore: <b>${secScore.toFixed(1)}</b> / 100</div>
            </div>
          </div>
        </div>
        <span class="badge ${secBadge.cls}">${secBadge.text}</span>
      </div>
      <div class="kpiList">${kpiRowsHtml}</div>
    `;
    return box;
  }

  function calculateAndRender(){
    const {input, values} = computeKPIs();

    // Working Capital Benchmark dynamisch: GrÃ¼n 5% Umsatz, Gelb 2.5% Umsatz, Rot <=0
    const wcGreen = input.u * 0.05;
    const wcYellow = input.u * 0.025;
    const liq = CONFIG.sections.find(s => s.id === "liq");
    const wcKpi = liq.kpis.find(k => k.id === "workingCapital");
    wcKpi.benchmark = {type:"higherBetter", red:0, yellow:wcYellow, green:wcGreen};

    const sectionsDiv = $("sections");
    sectionsDiv.innerHTML = "";

    const pdfModel = {
      generatedAt: new Date().toLocaleString("de-DE"),
      input,
      total: null,
      sections: []
    };

    let totalScore = 0;

    CONFIG.sections.forEach(section => {
      let sumW = 0;
      let sumScoreW = 0;
      let kpiRowsHtml = "";
      const secForPdf = { name: section.name, emoji: section.titleEmoji, score: 0, badge: null, kpis: [] };

      section.kpis.forEach(kpi => {
        const v = values[kpi.id];
        const sc = scoreFromBenchmark(v, kpi.benchmark);
        const bd = badgeFor(v, kpi.benchmark);

        sumW += kpi.weight;
        sumScoreW += sc * kpi.weight;

        kpiRowsHtml += buildKpiRow(kpi, v, bd, sc);

        secForPdf.kpis.push({
          name: kpi.name,
          valueText: formatValue(v, kpi.type),
          badgeText: bd.text,
          score: sc,
          weight: kpi.weight,
          explain: kpi.explain
        });
      });

      const secScore = sumW ? (sumScoreW / sumW) : 0;
      const secBadge = totalBadgeFromScore(secScore);

      secForPdf.score = secScore;
      secForPdf.badge = secBadge.text;

      totalScore += secScore * section.weightTotal;

      sectionsDiv.appendChild(buildSectionBox(section, secScore, secBadge, kpiRowsHtml));
      pdfModel.sections.push(secForPdf);
    });

    const tb = totalBadgeFromScore(totalScore);
    const interp = interpretTotal(totalScore);

    $("totalScoreText").textContent = `${totalScore.toFixed(1)} / 100`;
    $("totalBadge").className = `badge ${tb.cls}`;
    $("totalBadge").textContent = tb.text;

    $("totalInterpretation").innerHTML = `<b>Interpretation:</b> ${interp.label} â€“ ${interp.hint}`;
    $("totalExplain").textContent = "Gesamt = Durchschnitt der 4 Bereichsscores (je 25%)";

    $("results").style.display = "block";
    pdfModel.total = { score: totalScore, badge: tb.text, interpretation: interp.label, interpretationText: interp.hint };
    window.__PDF_MODEL__ = pdfModel;
  }

  function exportPDF(){
    const model = window.__PDF_MODEL__;
    if(!model){ alert("Bitte zuerst Kennzahlen berechnen."); return; }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:"mm", format:"a4" });

    const margin = 12;
    const maxW = 190;
    const lh = 6;

    function addTitle(text, y){
      doc.setFontSize(14);
      doc.text(text, margin, y);
      doc.setFontSize(11);
    }

    function addLines(lines, startY){
      let y = startY;
      lines.forEach(line => {
        if (y > 285) { doc.addPage(); y = 12; }
        doc.text(line, margin, y);
        y += lh;
      });
      return y;
    }

    // Seite 1: Ãœbersicht
    addTitle("Due-Diligence KPI Report", 14);
    doc.setFontSize(11);
    let y = 22;
    y = addLines([
      `Erstellt am: ${model.generatedAt}`,
      "",
      `Gesamtscore: ${model.total.score.toFixed(1)} / 100`,
      `Ampel: ${model.total.badge}`,
      `Interpretation: ${model.total.interpretation} â€“ ${model.total.interpretationText}`,
      "",
      "Eingaben (Auszug):",
      `- Umsatz: ${fmtEUR(model.input.u)} â‚¬`,
      `- Wareneinsatz: ${fmtEUR(model.input.w)} â‚¬`,
      `- EBITDA: ${fmtEUR(model.input.e)} â‚¬`,
      `- JahresÃ¼berschuss: ${fmtEUR(model.input.j)} â‚¬`,
      `- Eigenkapital: ${fmtEUR(model.input.ek)} â‚¬`,
      `- Gesamtkapital: ${fmtEUR(model.input.gk)} â‚¬`,
      `- Ã˜ Lagerbestand: ${fmtEUR(model.input.lb)} â‚¬`,
      `- Mitarbeiter (FTE): ${model.input.ma}`,
      `- VerkaufsflÃ¤che: ${model.input.vf} mÂ²`,
      `- UmlaufvermÃ¶gen: ${fmtEUR(model.input.uv)} â‚¬`,
      `- Kurzfr. Verbindlichkeiten: ${fmtEUR(model.input.kv)} â‚¬`,
      `- Operativer Cashflow: ${fmtEUR(model.input.cf)} â‚¬`,
      `- Marketingkosten: ${fmtEUR(model.input.mk)} â‚¬`,
      `- Bestellungen: ${model.input.b}`,
      `- Shopbesucher: ${model.input.s}`,
      `- Retouren: ${fmtEUR(model.input.r)} â‚¬`,
      ""
    ], y);

    doc.setFontSize(10);
    y = addLines(["Hinweis: Jede Kategorie folgt auf einer eigenen Seite."], y);

    // Je Bereich eigene Seite
    model.sections.forEach(sec => {
      doc.addPage();
      doc.setFontSize(13);
      doc.text(`${sec.emoji} ${sec.name} (25%)`, margin, 14);
      doc.setFontSize(11);
      doc.text(`Bereichsscore: ${sec.score.toFixed(1)} / 100   |   Ampel: ${sec.badge}`, margin, 22);

      const lines = [];
      lines.push("");
      lines.push("KPIs:");
      sec.kpis.forEach(k => {
        lines.push(`- ${k.name}: ${k.valueText} | ${k.badgeText} | KPI-Score: ${k.score.toFixed(1)}/100 | Gewicht: ${k.weight}`);
      });

      const wrapped = doc.splitTextToSize(lines.join("\n"), maxW);
      doc.setFontSize(10);
      addLines(wrapped, 32);
    });

    doc.save(`Due-Diligence_KPI_Report_${new Date().toISOString().slice(0,10)}.pdf`);
  }

  // Events
  $("calc").addEventListener("click", () => {
    try { calculateAndRender(); }
    catch(e){ alert(e.message || "Fehler bei der Berechnung."); }
  });

  $("pdf").addEventListener("click", () => {
    try { exportPDF(); }
    catch{ alert("PDF-Export fehlgeschlagen."); }
  });

  $("reset").addEventListener("click", () => {
    document.querySelectorAll("input").forEach(i => i.value = "");
    $("results").style.display = "none";
    window.__PDF_MODEL__ = null;
  });

  $("fillDemo").addEventListener("click", () => {
    $("umsatz").value = "1.250.000";
    $("wareneinsatz").value = "720.000";
    $("ebitda").value = "140.000";
    $("jahresueberschuss").value = "70.000";
    $("eigenkapital").value = "280.000";
    $("gesamtkapital").value = "900.000";
    $("lagerbestand").value = "180.000";
    $("mitarbeiter").value = "8";
    $("verkaufsflaeche").value = "250";
    $("umlaufvermoegen").value = "320.000";
    $("kurzfristigeVerbindlichkeiten").value = "210.000";
    $("operativerCashflow").value = "95.000";
    $("marketingkosten").value = "85.000";
    $("bestellungen").value = "12.500";
    $("shopbesucher").value = "520.000";
    $("retouren").value = "55.000";
  });
</script>
</body>
</html>
